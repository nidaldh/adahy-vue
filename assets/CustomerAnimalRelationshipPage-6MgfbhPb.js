import{d as O,p as G,r as h,o as x,q as L,s as K,x as le,c as u,a as e,m as f,y as v,f as F,v as q,F as J,i as X,t as c,z as Y,h as o,n as I,_ as z,w as ne,A as te,B as Se,C as we,D as ae,b as H,g as Ue,G as Ie,H as Ee}from"./index-D2cXNYYD.js";const Te={class:"customer-selector",dir:"rtl"},De={class:"selector-content"},Ae={class:"search-container"},Pe={class:"search-input-wrapper"},Ne={key:0,class:"customers-dropdown"},Me=["onClick","onMouseenter"],Fe={class:"customer-info"},Le={class:"customer-name"},Ve={class:"customer-details"},Be={key:0,class:"phone"},Re={class:"animals-count"},qe={key:1,class:"no-results"},Ke=O({__name:"CustomerSelector",props:{selectedCustomer:{}},emits:["customer-selected","customer-cleared"],setup(P,{emit:_}){const r=P,k=_,i=G(),d=h(""),y=h(!1),p=h(-1),U=h(null);x(()=>{i.fetchCustomers()});const m=L(()=>{if(!d.value.trim())return i.customers.slice(0,10);const s=d.value.toLowerCase();return i.customers.filter(l=>{var g;return l.name.toLowerCase().includes(s)||((g=l.phone)==null?void 0:g.toLowerCase().includes(s))}).slice(0,10)}),b=()=>{y.value=!0,p.value=-1},S=s=>{d.value=s.name,y.value=!1,p.value=-1,k("customer-selected",s)},$=()=>{d.value="",y.value=!1,p.value=-1,k("customer-cleared"),Y(()=>{var s;(s=U.value)==null||s.focus()})},E=s=>{if(!(!y.value||m.value.length===0))switch(s.key){case"ArrowDown":s.preventDefault(),p.value=Math.min(p.value+1,m.value.length-1);break;case"ArrowUp":s.preventDefault(),p.value=Math.max(p.value-1,-1);break;case"Enter":s.preventDefault(),p.value>=0&&S(m.value[p.value]);break;case"Escape":y.value=!1,p.value=-1;break}},a=s=>{s.target.closest(".customer-selector")||(y.value=!1,p.value=-1)};return K(()=>r.selectedCustomer,s=>{s?(d.value=s.name,y.value=!1):d.value=""},{immediate:!0}),x(()=>{document.addEventListener("click",a)}),le(()=>{document.removeEventListener("click",a)}),(s,l)=>(o(),u("div",Te,[l[8]||(l[8]=e("div",{class:"selector-header"},[e("h3",null,[e("i",{class:"fas fa-users"}),f(" اختيار العميل")])],-1)),e("div",De,[e("div",Ae,[e("div",Pe,[l[3]||(l[3]=e("i",{class:"fas fa-search search-icon"},null,-1)),F(e("input",{ref_key:"searchInput",ref:U,type:"text","onUpdate:modelValue":l[0]||(l[0]=g=>d.value=g),placeholder:"ابحث عن العميل بالاسم أو رقم الهاتف...",class:"search-input",onInput:b,onFocus:l[1]||(l[1]=g=>y.value=!0),onKeydown:E},null,544),[[q,d.value]]),s.selectedCustomer?(o(),u("button",{key:0,onClick:$,class:"clear-btn",type:"button"},l[2]||(l[2]=[e("i",{class:"fas fa-times"},null,-1)]))):v("",!0)]),y.value&&m.value.length>0?(o(),u("div",Ne,[(o(!0),u(J,null,X(m.value,(g,C)=>{var T;return o(),u("div",{key:g.id,class:I(["customer-option",{active:C===p.value}]),onClick:N=>S(g),onMouseenter:N=>p.value=C},[e("div",Fe,[e("div",Le,[l[4]||(l[4]=e("i",{class:"fas fa-user"},null,-1)),f(" "+c(g.name),1)]),e("div",Ve,[g.phone?(o(),u("span",Be,[l[5]||(l[5]=e("i",{class:"fas fa-phone"},null,-1)),f(" "+c(g.phone),1)])):v("",!0),e("span",Re,[l[6]||(l[6]=e("i",{class:"fas fa-sheep"},null,-1)),f(" "+c(((T=g.animals)==null?void 0:T.length)||0)+" أضحية ",1)])])])],42,Me)}),128))])):v("",!0),y.value&&d.value&&m.value.length===0?(o(),u("div",qe,[l[7]||(l[7]=e("i",{class:"fas fa-search"},null,-1)),f(' لا توجد نتائج للبحث "'+c(d.value)+'" ',1)])):v("",!0)])])]))}}),xe=z(Ke,[["__scopeId","data-v-d21bb22a"]]),Oe={class:"sacrifice-form",dir:"rtl"},ze={class:"form-header"},We={class:"form-grid"},je={class:"form-group"},He={key:0,class:"error-message"},Ge={class:"form-group"},Je={key:0,class:"error-message"},Xe={class:"form-group"},Ye={key:0,class:"error-message"},Ze={class:"form-group"},Qe={key:0,class:"error-message"},es={class:"form-group"},ss=["value"],ts={class:"form-group"},as={class:"form-group full-width"},ls={key:0,class:"error-message"},ns={class:"form-actions"},is=["disabled"],os={key:0,class:"fas fa-spinner fa-spin"},us=["disabled"],rs=O({__name:"SacrificeForm",props:{isLoading:{type:Boolean},existingAnimals:{},animalToEdit:{}},emits:["addSacrifice","update-sacrifice"],setup(P,{emit:_}){const r=P,k=_,i=h({type:"",number:"",weight:"",pricePerUnit:"",status:"حي",notes:""}),d=h({}),y=a=>{d.value[a]&&delete d.value[a]},p=a=>{if(a==="-"||String(a).trim()==="")return 0;const s=parseFloat(String(a));return isNaN(s)?0:s},U=L(()=>{const a=p(i.value.weight),s=p(i.value.pricePerUnit);return parseFloat((a*s).toFixed(2))}),m=a=>{var s;switch(y(a),a){case"type":i.value.type||(d.value.type="نوع الأضحية مطلوب");break;case"number":const l=String(i.value.number).trim();!l||l==="-"?d.value.number="رقم الأضحية مطلوب":i.value.type&&((s=r.existingAnimals)!=null&&s.some(C=>C.type===i.value.type&&String(C.number)===l&&(!r.animalToEdit||C.id!==r.animalToEdit.id)))&&(d.value.number="هذا الرقم مستخدم بالفعل لنفس نوع الأضحية");break;case"weight":p(i.value.weight)<=0&&(d.value.weight="الوزن يجب أن يكون أكبر من صفر");break;case"pricePerUnit":p(i.value.pricePerUnit)<=0&&(d.value.pricePerUnit="السعر يجب أن يكون أكبر من صفر");break}},b=()=>(m("type"),m("number"),m("weight"),m("pricePerUnit"),Object.keys(d.value).length===0),S=L(()=>{var s;if(!i.value.type)return!1;const a=String(i.value.number).trim();return!a||a==="-"||i.value.type&&a&&a!=="-"&&((s=r.existingAnimals)==null?void 0:s.some(g=>g.type===i.value.type&&String(g.number)===a&&(!r.animalToEdit||g.id!==r.animalToEdit.id)))||p(i.value.weight)<=0||p(i.value.pricePerUnit)<=0?!1:Object.keys(d.value).length===0}),$=()=>{i.value={type:"",number:"",weight:"",pricePerUnit:"",status:"حي",notes:""},d.value={}},E=()=>{if(!b())return;const a=p(i.value.weight),s=p(i.value.pricePerUnit),l=String(i.value.number).trim()==="-"||String(i.value.number).trim()===""?"":String(i.value.number).trim(),g=String(i.value.notes).trim()==="-"||String(i.value.notes).trim()===""?"":String(i.value.notes).trim(),C={type:i.value.type,number:l,weight:a,pricePerUnit:s,status:i.value.status,notes:g,compositeKey:`${i.value.type}_${l}`,total:parseFloat((a*s).toFixed(2)),count:1};if(r.animalToEdit){const T={...r.animalToEdit,...C};k("update-sacrifice",T)}else k("addSacrifice",C),$()};return K(()=>r.animalToEdit,a=>{a?(i.value={type:a.type,number:a.number===null||a.number===void 0||String(a.number).trim()===""?"-":String(a.number),weight:a.weight===null||a.weight===void 0||String(a.weight).trim()===""?"-":String(a.weight),pricePerUnit:a.pricePerUnit===null||a.pricePerUnit===void 0||String(a.pricePerUnit).trim()===""?"-":String(a.pricePerUnit),status:a.status,notes:a.notes===null||a.notes===void 0||String(a.notes).trim()===""?"-":String(a.notes)},d.value={}):$()},{immediate:!0}),(a,s)=>(o(),u("div",Oe,[e("div",ze,[e("h4",null,[e("i",{class:I(["fas",r.animalToEdit?"fa-edit":"fa-plus-circle"])},null,2),f(" "+c(r.animalToEdit?"تعديل بيانات الأضحية":"إضافة أضحية جديدة"),1)])]),e("form",{onSubmit:ne(E,["prevent"]),class:"sacrifice-form-content"},[e("div",We,[e("div",je,[s[17]||(s[17]=e("label",{for:"animalType",class:"form-label"},[e("i",{class:"fas fa-paw"}),f(" نوع الأضحية * ")],-1)),F(e("select",{id:"animalType","onUpdate:modelValue":s[0]||(s[0]=l=>i.value.type=l),required:"",class:I(["form-input",{"is-invalid":d.value.type}]),onBlur:s[1]||(s[1]=()=>m("type")),onChange:s[2]||(s[2]=l=>y("type"))},s[16]||(s[16]=[Se('<option value="" disabled data-v-8fa53e41>اختر نوع الأضحية</option><option value="خروف" data-v-8fa53e41>خروف</option><option value="تيس" data-v-8fa53e41>تيس</option><option value="عجل" data-v-8fa53e41>عجل</option><option value="جمل" data-v-8fa53e41>جمل</option><option value="بقر" data-v-8fa53e41>بقر</option>',6)]),34),[[te,i.value.type]]),d.value.type?(o(),u("div",He,c(d.value.type),1)):v("",!0)]),e("div",Ge,[s[18]||(s[18]=e("label",{for:"animalNumber",class:"form-label"},[e("i",{class:"fas fa-tag"}),f(" رقم الأضحية/التعريف * ")],-1)),F(e("input",{id:"animalNumber",type:"text","onUpdate:modelValue":s[3]||(s[3]=l=>i.value.number=l),required:"",placeholder:"مثال: A101، خروف_1 أو -",class:I(["form-input",{"is-invalid":d.value.number}]),onInput:s[4]||(s[4]=l=>y("number")),onBlur:s[5]||(s[5]=()=>m("number"))},null,34),[[q,i.value.number]]),d.value.number?(o(),u("div",Je,c(d.value.number),1)):v("",!0),s[19]||(s[19]=e("small",{class:"field-hint"},"رقم فريد لتمييز الأضحية",-1))]),e("div",Xe,[s[20]||(s[20]=e("label",{for:"animalWeight",class:"form-label"},[e("i",{class:"fas fa-weight-hanging"}),f(" الوزن (كجم) * ")],-1)),F(e("input",{id:"animalWeight",type:"text","onUpdate:modelValue":s[6]||(s[6]=l=>i.value.weight=l),placeholder:"مثال: 25.5 أو -",class:I(["form-input",{"is-invalid":d.value.weight}]),onInput:s[7]||(s[7]=l=>y("weight")),onBlur:s[8]||(s[8]=()=>m("weight"))},null,34),[[q,i.value.weight]]),d.value.weight?(o(),u("div",Ye,c(d.value.weight),1)):v("",!0)]),e("div",Ze,[s[21]||(s[21]=e("label",{for:"animalPrice",class:"form-label"},[e("i",{class:"fas fa-money-bill-wave"}),f(" سعر الكيلو (شيكل) * ")],-1)),F(e("input",{id:"animalPrice",type:"text","onUpdate:modelValue":s[9]||(s[9]=l=>i.value.pricePerUnit=l),placeholder:"مثال: 35.00 أو -",class:I(["form-input",{"is-invalid":d.value.pricePerUnit}]),onInput:s[10]||(s[10]=l=>y("pricePerUnit")),onBlur:s[11]||(s[11]=()=>m("pricePerUnit"))},null,34),[[q,i.value.pricePerUnit]]),d.value.pricePerUnit?(o(),u("div",Qe,c(d.value.pricePerUnit),1)):v("",!0)]),e("div",es,[s[22]||(s[22]=e("label",{for:"animalTotal",class:"form-label"},[e("i",{class:"fas fa-calculator"}),f(" المجموع (شيكل) ")],-1)),e("input",{id:"animalTotal",type:"number",value:U.value,readonly:"",class:"form-input total-input",placeholder:"0.00"},null,8,ss)]),e("div",ts,[s[24]||(s[24]=e("label",{for:"animalStatus",class:"form-label"},[e("i",{class:"fas fa-heartbeat"}),f(" حالة الأضحية ")],-1)),F(e("select",{id:"animalStatus","onUpdate:modelValue":s[12]||(s[12]=l=>i.value.status=l),class:"form-input"},s[23]||(s[23]=[e("option",{value:"حي"},"حي",-1),e("option",{value:"جاهز"},"جاهز",-1),e("option",{value:"مذبوح"},"مذبوح",-1),e("option",{value:"ملغي"},"ملغي",-1)]),512),[[te,i.value.status]])]),e("div",as,[s[25]||(s[25]=e("label",{for:"animalNotes",class:"form-label"},[e("i",{class:"fas fa-sticky-note"}),f(" ملاحظات ")],-1)),F(e("textarea",{id:"animalNotes","onUpdate:modelValue":s[13]||(s[13]=l=>i.value.notes=l),rows:"3",placeholder:"ملاحظات اختيارية حول الأضحية، أو -",class:"form-input",onInput:s[14]||(s[14]=l=>y("notes")),onBlur:s[15]||(s[15]=()=>m("notes"))},null,544),[[q,i.value.notes]]),d.value.notes?(o(),u("div",ls,c(d.value.notes),1)):v("",!0),s[26]||(s[26]=e("small",{class:"field-hint"},"ملاحظات اختيارية مثل صفات خاصة أو تعليمات",-1))])]),e("div",ns,[e("button",{type:"submit",class:"btn btn-primary",disabled:a.isLoading||!S.value},[a.isLoading?(o(),u("i",os)):(o(),u("i",{key:1,class:I(["fas",r.animalToEdit?"fa-save":"fa-plus"])},null,2)),f(" "+c(a.isLoading?r.animalToEdit?"جاري التحديث...":"جاري الإضافة...":r.animalToEdit?"تحديث البيانات":"إضافة الأضحية"),1)],8,is),e("button",{type:"button",onClick:$,class:"btn btn-secondary",disabled:a.isLoading},s[27]||(s[27]=[e("i",{class:"fas fa-eraser"},null,-1),f(" مسح الحقول ")]),8,us)])],32)]))}}),ds=z(rs,[["__scopeId","data-v-8fa53e41"]]),cs={class:"sacrifice-list",dir:"rtl"},ms={class:"list-header"},vs={class:"count-badge"},fs={key:0,class:"empty-state"},ps={key:1,class:"sacrifices-container"},gs=["id"],ys={class:"sacrifice-selection"},bs=["id","checked","onChange"],hs={class:"sacrifice-info"},Cs={class:"sacrifice-header"},ks={class:"sacrifice-title"},$s={class:"composite-key"},_s={class:"sacrifice-status"},Ss=["value","onChange"],ws=["disabled"],Us={class:"sacrifice-details"},Is={class:"detail-item"},Es={class:"detail-value"},Ts={class:"detail-item"},Ds={class:"detail-value"},As={class:"detail-item"},Ps={class:"detail-value"},Ns={class:"detail-item total"},Ms={class:"detail-value"},Fs={key:0,class:"detail-item notes"},Ls={class:"detail-value notes-text"},Vs={class:"sacrifice-actions"},Bs=["onClick"],Rs={key:2,class:"summary-section"},qs={class:"summary-card"},Ks={class:"summary-item"},xs={class:"summary-value"},Os={class:"summary-item"},zs={class:"summary-value"},Ws={class:"summary-item total-amount"},js={class:"summary-value"},Hs=O({__name:"SacrificeList",props:{sacrifices:{},highlightAnimalId:{}},emits:["update-status","request-edit-animal"],setup(P,{emit:_}){const r=P,k=_,i=h([]),d=h([]),y=L(()=>r.sacrifices.reduce((a,s)=>a+(s.weight||0),0).toFixed(1)),p=L(()=>r.sacrifices.reduce((a,s)=>a+(s.total||0),0)),U=()=>{r.highlightAnimalId&&Y(()=>{const a=document.getElementById(`sacrifice-card-${r.highlightAnimalId}`);a&&(a.scrollIntoView({behavior:"smooth",block:"center"}),a.classList.add("flash-highlight"),setTimeout(()=>{a.classList.remove("flash-highlight")},3e3))})};K(()=>r.highlightAnimalId,a=>{a&&U()});const m=a=>{const s=i.value.indexOf(a);s>-1?i.value.splice(s,1):i.value.push(a)},b=(a,s)=>{k("update-status",a,s)},S=a=>{k("request-edit-animal",a)},$=a=>typeof a!="number"?"N/A":new Intl.NumberFormat("he-IL",{style:"currency",currency:"ILS"}).format(a),E=a=>({حي:"status-alive",جاهز:"status-ready",مذبوح:"status-slaughtered",ملغي:"status-cancelled"})[a]||"";return x(()=>{U()}),(a,s)=>(o(),u("div",cs,[e("div",ms,[e("h4",null,[s[0]||(s[0]=e("i",{class:"fas fa-list-ul"},null,-1)),s[1]||(s[1]=f(" أضاحي العميل ")),e("span",vs,c(a.sacrifices.length),1)])]),a.sacrifices.length===0?(o(),u("div",fs,s[2]||(s[2]=[e("div",{class:"empty-content"},[e("i",{class:"fas fa-sheep fa-2x"}),e("h5",null,"لا توجد أضاحي مسجلة"),e("p",null,"استخدم النموذج أعلاه لإضافة أضاحي جديدة للعميل")],-1)]))):(o(),u("div",ps,[(o(!0),u(J,null,X(a.sacrifices,l=>(o(),u("div",{key:l.id,class:I(["sacrifice-card",{selected:i.value.includes(l.id),highlighted:l.id===a.highlightAnimalId}]),id:`sacrifice-card-${l.id}`,ref_for:!0,ref_key:"sacrificeCards",ref:d},[e("div",ys,[e("input",{type:"checkbox",id:`sacrifice-${l.id}`,checked:i.value.includes(l.id),onChange:g=>m(l.id),class:"sacrifice-checkbox"},null,40,bs)]),e("div",hs,[e("div",Cs,[e("div",ks,[e("h5",null,[s[3]||(s[3]=e("i",{class:"fas fa-paw"},null,-1)),f(" "+c(l.type)+" - "+c(l.number),1)]),e("span",$s,c(l.compositeKey),1)]),e("div",_s,[e("select",{value:l.status,onChange:g=>b(l.id,g.target.value),class:I(["status-select",E(l.status)])},[s[4]||(s[4]=e("option",{value:"حي"},"حي",-1)),s[5]||(s[5]=e("option",{value:"جاهز"},"جاهز",-1)),s[6]||(s[6]=e("option",{value:"مذبوح"},"مذبوح",-1)),e("option",{value:"ملغي",disabled:l.status!=="حي"},"ملغي",8,ws)],42,Ss)])]),e("div",Us,[e("div",Is,[s[7]||(s[7]=e("i",{class:"fas fa-tag"},null,-1)),s[8]||(s[8]=e("span",{class:"detail-label"},"رقم الأضحية:",-1)),e("span",Es,c(l.number),1)]),e("div",Ts,[s[9]||(s[9]=e("i",{class:"fas fa-weight-hanging"},null,-1)),s[10]||(s[10]=e("span",{class:"detail-label"},"الوزن:",-1)),e("span",Ds,c(l.weight)+" كجم",1)]),e("div",As,[s[11]||(s[11]=e("i",{class:"fas fa-money-bill-wave"},null,-1)),s[12]||(s[12]=e("span",{class:"detail-label"},"سعر الكيلو:",-1)),e("span",Ps,c($(l.pricePerUnit)),1)]),e("div",Ns,[s[13]||(s[13]=e("i",{class:"fas fa-calculator"},null,-1)),s[14]||(s[14]=e("span",{class:"detail-label"},"المجموع:",-1)),e("span",Ms,c($(l.total)),1)]),l.notes?(o(),u("div",Fs,[s[15]||(s[15]=e("i",{class:"fas fa-sticky-note"},null,-1)),s[16]||(s[16]=e("span",{class:"detail-label"},"ملاحظات:",-1)),e("span",Ls,c(l.notes),1)])):v("",!0)])]),e("div",Vs,[e("button",{onClick:g=>S(l),class:"action-btn edit-btn",title:"تعديل الأضحية"},s[17]||(s[17]=[e("i",{class:"fas fa-pencil-alt"},null,-1)]),8,Bs)])],10,gs))),128))])),a.sacrifices.length>0?(o(),u("div",Rs,[e("div",qs,[e("div",Ks,[s[18]||(s[18]=e("i",{class:"fas fa-sheep"},null,-1)),s[19]||(s[19]=e("span",{class:"summary-label"},"إجمالي الأضاحي:",-1)),e("span",xs,c(a.sacrifices.length)+" رأس",1)]),e("div",Os,[s[20]||(s[20]=e("i",{class:"fas fa-weight-hanging"},null,-1)),s[21]||(s[21]=e("span",{class:"summary-label"},"إجمالي الوزن:",-1)),e("span",zs,c(y.value)+" كجم",1)]),e("div",Ws,[s[22]||(s[22]=e("i",{class:"fas fa-money-bill-wave"},null,-1)),s[23]||(s[23]=e("span",{class:"summary-label"},"إجمالي المبلغ:",-1)),e("span",js,c($(p.value)),1)])])])):v("",!0)]))}}),Gs=z(Hs,[["__scopeId","data-v-a6c3f162"]]),Js={class:"customer-sacrifice-manager",dir:"rtl"},Xs={class:"manager-header"},Ys={key:0,class:"customer-info"},Zs={class:"customer-name"},Qs={key:0,class:"customer-phone"},et={key:1,class:"customer-notes-section"},st={class:"notes-display"},tt={key:0,class:"notes-view"},at={key:0,class:"notes-content"},lt={key:1,class:"notes-edit"},nt=["onKeydown"],it={class:"notes-actions"},ot=["disabled"],ut={class:"manager-content"},rt={class:"add-section"},dt={class:"section-header"},ct={class:"header-actions"},mt={key:0,class:"alert alert-error",role:"alert"},vt={key:1,class:"alert alert-success",role:"alert"},ft={key:2,class:"add-form-container"},pt={class:"list-section"},gt={key:0,class:"empty-state"},yt={key:0,class:"discount-management-section card-style"},bt={class:"section-header"},ht={class:"header-actions"},Ct={key:0,class:"current-discount-display"},kt={class:"discount-info"},$t={class:"discount-amount"},_t={class:"value"},St={key:0,class:"discount-reason"},wt={class:"value"},Ut={key:1,class:"no-discount-message"},It={key:2,class:"discount-edit-container"},Et={class:"discount-actions"},Tt=["disabled"],Dt=["disabled"],At={key:1,class:"financial-summary-section card-style"},Pt={class:"summary-details"},Nt={class:"summary-item"},Mt={class:"value total-animals-price"},Ft={key:0,class:"summary-item discount-item"},Lt={class:"value discount-amount"},Vt={key:1,class:"summary-item discount-reason"},Bt={class:"value reason-text"},Rt={class:"summary-item"},qt={class:"value total-payments"},Kt={class:"summary-item balance"},xt={key:2,class:"payments-list-section card-style"},Ot={key:0},zt={key:1},Wt={key:3,class:"confirmation-overlay"},jt={class:"confirmation-dialog"},Ht={class:"dialog-header"},Gt={class:"dialog-body"},Jt=O({__name:"CustomerSacrificeManager",props:{selectedCustomer:{},highlightAnimalId:{}},emits:["dataUpdated"],setup(P,{emit:_}){const r=P,k=G(),i=_,d=h(!1),y=h(!1),p=h(!1),U=h(!1),m=h(null),b=h({title:"",message:"",action:null}),S=h(!1),$=h(""),E=h(!1),a=h(null),s=h(null),l=h(!1),g=h(!1),C=h(null),T=h(""),N=h(""),D=h(null),V=n=>typeof n!="number"||isNaN(n)?"N/A":new Intl.NumberFormat("he-IL",{style:"currency",currency:"ILS"}).format(n);K(()=>r.highlightAnimalId,n=>{s.value=n});const A=n=>{T.value=n,N.value="",D.value&&clearTimeout(D.value),D.value=setTimeout(()=>{T.value=""},5e3)},R=n=>{N.value=n,T.value="",D.value&&clearTimeout(D.value),D.value=setTimeout(()=>{N.value=""},3e3)},M=()=>{T.value="",N.value="",D.value&&(clearTimeout(D.value),D.value=null)},ie=n=>typeof n!="number"||isNaN(n)?"balance-zero":n<0?"balance-credit":n>0?"balance-debit":"balance-zero",W=L(()=>{var n;return((n=r.selectedCustomer)==null?void 0:n.animals)||[]}),B=L(()=>r.selectedCustomer&&we(r.selectedCustomer.discount)),oe=L(()=>{var n;return C.value&&C.value.amount>0&&C.value.amount<=(((n=r.selectedCustomer)==null?void 0:n.totalAmount)||0)}),ue=()=>{l.value=!0,C.value={amount:0,reason:""}},re=()=>{r.selectedCustomer&&(l.value=!0,C.value={amount:r.selectedCustomer.discount||0,reason:r.selectedCustomer.discountReason||""})},Z=()=>{l.value=!1,C.value=null},de=async()=>{if(!(!r.selectedCustomer||!C.value||g.value))try{g.value=!0,M(),await k.applyCustomerDiscount(r.selectedCustomer.id,C.value.amount,C.value.reason||"خصم عميل","المستخدم الحالي"),l.value=!1,C.value=null,i("dataUpdated"),R("تم حفظ خصم العميل بنجاح")}catch(n){const t=n instanceof Error?n.message:"حدث خطأ غير متوقع أثناء حفظ الخصم";A(t)}finally{g.value=!1}},ce=()=>{r.selectedCustomer&&(b.value={title:"تأكيد إزالة الخصم",message:`هل أنت متأكد من رغبتك في إزالة خصم العميل (${V(r.selectedCustomer.discount)})?`,action:me},U.value=!0)},me=async()=>{if(r.selectedCustomer)try{M(),await k.removeCustomerDiscount(r.selectedCustomer.id),i("dataUpdated"),R("تم إزالة خصم العميل بنجاح")}catch(n){const t=n instanceof Error?n.message:"حدث خطأ غير متوقع أثناء إزالة الخصم";A(t)}},ve=n=>{C.value=n},fe=async()=>{var n;S.value=!0,$.value=((n=r.selectedCustomer)==null?void 0:n.notes)||"",await Y(),a.value&&a.value.focus()},Q=()=>{S.value=!1,$.value=""},ee=async()=>{if(!(E.value||!r.selectedCustomer))try{E.value=!0,M(),await k.updateCustomer({id:r.selectedCustomer.id,notes:$.value.trim()}),S.value=!1,$.value="",i("dataUpdated"),R("تم حفظ الملاحظات بنجاح")}catch(n){const t=n instanceof Error?n.message:"حدث خطأ غير متوقع أثناء حفظ الملاحظات";A(t)}finally{E.value=!1}},pe=()=>{d.value=!d.value,d.value||(m.value=null)},ge=async n=>{if(r.selectedCustomer)try{y.value=!0,M();const t={...n,id:he(),createdAt:Date.now(),notes:n.notes||""};await k.addAnimalToCustomer(r.selectedCustomer.id,t),d.value=!1,i("dataUpdated"),R("تم إضافة الأضحية بنجاح")}catch(t){const w=t instanceof Error?t.message:"حدث خطأ غير متوقع أثناء إضافة الأضحية";A(w)}finally{y.value=!1}},ye=async(n,t)=>{if(!r.selectedCustomer)return;const w=W.value.find(j=>j.id===n);if(!w){A("لم يتم العثور على الأضحية للتحديث");return}if(!["حي","جاهز","مذبوح","ملغي"].includes(t)){A("حالة غير صحيحة: "+t);return}if(t==="ملغي"&&w.status!=="حي"){A('لا يمكن إلغاء الأضحية إلا إذا كانت حالتها "حي"'),i("dataUpdated");return}try{p.value=!0,M(),await k.updateCustomerAnimal(r.selectedCustomer.id,n,{status:t}),i("dataUpdated"),R("تم تحديث حالة الأضحية بنجاح")}catch(j){const _e=j instanceof Error?j.message:"حدث خطأ غير متوقع أثناء تحديث حالة الأضحية";A(_e)}finally{p.value=!1}},se=()=>{U.value=!1,b.value={title:"",message:"",action:null}},be=()=>{b.value.action&&b.value.action(),se()},he=()=>`animal_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,Ce=n=>{m.value=n,d.value=!0},ke=()=>{m.value=null,d.value=!1},$e=async n=>{if(!(!r.selectedCustomer||!m.value))try{y.value=!0,M(),await k.updateAnimalDetails({customerId:r.selectedCustomer.id,animalId:m.value.id,updates:n}),m.value=null,d.value=!1,i("dataUpdated"),R("تم تحديث الأضحية بنجاح")}catch(t){const w=t instanceof Error?t.message:"حدث خطأ غير متوقع أثناء تحديث الأضحية";A(w)}finally{y.value=!1}};return K(()=>r.selectedCustomer,n=>{n||(d.value=!1)}),x(()=>{r.highlightAnimalId&&(s.value=r.highlightAnimalId)}),le(()=>{D.value&&clearTimeout(D.value)}),(n,t)=>(o(),u("div",Js,[e("div",Xs,[n.selectedCustomer?(o(),u("div",Ys,[e("span",Zs,c(n.selectedCustomer.name),1),n.selectedCustomer.phone?(o(),u("span",Qs,[t[2]||(t[2]=e("i",{class:"fas fa-phone"},null,-1)),f(" "+c(n.selectedCustomer.phone),1)])):v("",!0)])):v("",!0),n.selectedCustomer?(o(),u("div",et,[e("div",st,[S.value?(o(),u("div",lt,[F(e("textarea",{ref_key:"notesTextarea",ref:a,"onUpdate:modelValue":t[0]||(t[0]=w=>$.value=w),class:"notes-textarea",placeholder:"اكتب ملاحظاتك حول العميل هنا...",rows:"3",onKeydown:[ae(ne(ee,["ctrl"]),["enter"]),ae(Q,["escape"])]},null,40,nt),[[q,$.value]]),e("div",it,[e("button",{onClick:ee,class:"btn btn-sm btn-primary",disabled:E.value},[t[5]||(t[5]=e("i",{class:"fas fa-save"},null,-1)),f(" "+c(E.value?"جاري الحفظ...":"حفظ"),1)],8,ot),e("button",{onClick:Q,class:"btn btn-sm btn-secondary"},t[6]||(t[6]=[e("i",{class:"fas fa-times"},null,-1),f(" إلغاء ")]))]),t[7]||(t[7]=e("div",{class:"notes-hint"},[e("small",null,"اضغط Ctrl+Enter للحفظ أو Escape للإلغاء")],-1))])):(o(),u("div",tt,[n.selectedCustomer.notes?(o(),u("div",at,[t[3]||(t[3]=e("i",{class:"fas fa-sticky-note"},null,-1)),e("span",null,c(n.selectedCustomer.notes),1)])):v("",!0),e("button",{onClick:fe,class:"btn btn-sm btn-outline"},[t[4]||(t[4]=e("i",{class:"fas fa-edit"},null,-1)),f(" "+c(n.selectedCustomer.notes?"تعديل الملاحظات":"إضافة ملاحظات"),1)])]))])])):v("",!0)]),e("div",ut,[e("div",rt,[e("div",dt,[e("h4",null,[e("i",{class:I(["fas",m.value?"fa-edit":"fa-plus-circle"])},null,2),f(" "+c(m.value?"تعديل بيانات الأضحية":"إضافة أضحية جديدة"),1)]),e("div",ct,[m.value?v("",!0):(o(),u("button",{key:0,onClick:pe,class:I(["btn btn-primary btn-sm",{active:d.value}])},[e("i",{class:I(["fas",d.value?"fa-minus":"fa-plus"])},null,2),f(" "+c(d.value?"إخفاء النموذج":"إظهار النموذج"),1)],2)),m.value?(o(),u("button",{key:1,onClick:ke,class:"btn btn-secondary btn-sm"},t[8]||(t[8]=[e("i",{class:"fas fa-times"},null,-1),f(" إلغاء التعديل ")]))):v("",!0)])]),T.value?(o(),u("div",mt,[t[10]||(t[10]=e("i",{class:"fas fa-exclamation-triangle"},null,-1)),e("span",null,c(T.value),1),e("button",{onClick:M,class:"alert-close"},t[9]||(t[9]=[e("i",{class:"fas fa-times"},null,-1)]))])):v("",!0),N.value?(o(),u("div",vt,[t[12]||(t[12]=e("i",{class:"fas fa-check-circle"},null,-1)),e("span",null,c(N.value),1),e("button",{onClick:M,class:"alert-close"},t[11]||(t[11]=[e("i",{class:"fas fa-times"},null,-1)]))])):v("",!0),d.value||m.value?(o(),u("div",ft,[H(ds,{onAddSacrifice:ge,onUpdateSacrifice:$e,"is-loading":y.value,"existing-animals":W.value,animalToEdit:m.value},null,8,["is-loading","existing-animals","animalToEdit"])])):v("",!0)]),e("div",pt,[W.value.length===0?(o(),u("div",gt,t[13]||(t[13]=[e("i",{class:"fas fa-sheep fa-3x"},null,-1),e("p",null,"لا توجد أضاحي مسجلة لهذا العميل بعد",-1),e("p",{class:"text-muted"},"استخدم النموذج أعلاه لإضافة أضحية جديدة",-1)]))):(o(),Ue(Gs,{key:1,sacrifices:W.value,onUpdateStatus:ye,onRequestEditAnimal:Ce,"highlight-animal-id":s.value},null,8,["sacrifices","highlight-animal-id"]))])]),n.selectedCustomer?(o(),u("div",yt,[e("div",bt,[t[18]||(t[18]=e("h4",null,[e("i",{class:"fas fa-percentage"}),f(" إدارة خصم العميل ")],-1)),e("div",ht,[!l.value&&!B.value?(o(),u("button",{key:0,onClick:ue,class:"btn btn-primary btn-sm"},t[14]||(t[14]=[e("i",{class:"fas fa-plus"},null,-1),f(" إضافة خصم ")]))):v("",!0),!l.value&&B.value?(o(),u("button",{key:1,onClick:re,class:"btn btn-outline btn-sm"},t[15]||(t[15]=[e("i",{class:"fas fa-edit"},null,-1),f(" تعديل الخصم ")]))):v("",!0),!l.value&&B.value?(o(),u("button",{key:2,onClick:ce,class:"btn btn-danger btn-sm"},t[16]||(t[16]=[e("i",{class:"fas fa-trash"},null,-1),f(" إزالة الخصم ")]))):v("",!0),l.value?(o(),u("button",{key:3,onClick:Z,class:"btn btn-secondary btn-sm"},t[17]||(t[17]=[e("i",{class:"fas fa-times"},null,-1),f(" إلغاء ")]))):v("",!0)])]),!l.value&&B.value?(o(),u("div",Ct,[e("div",kt,[e("div",$t,[t[19]||(t[19]=e("span",{class:"label"},"مبلغ الخصم:",-1)),e("span",_t,c(V(n.selectedCustomer.discount)),1)]),n.selectedCustomer.discountReason?(o(),u("div",St,[t[20]||(t[20]=e("span",{class:"label"},"السبب:",-1)),e("span",wt,c(n.selectedCustomer.discountReason),1)])):v("",!0)])])):v("",!0),!l.value&&!B.value?(o(),u("div",Ut,t[21]||(t[21]=[e("i",{class:"fas fa-info-circle"},null,-1),e("span",null,"لا يوجد خصم مطبق على هذا العميل حالياً",-1)]))):v("",!0),l.value?(o(),u("div",It,[H(Ie,{modelValue:C.value,"onUpdate:modelValue":t[1]||(t[1]=w=>C.value=w),"total-amount":n.selectedCustomer.totalAmount||0,"applied-by":"المستخدم الحالي",onChange:ve},null,8,["modelValue","total-amount"]),e("div",Et,[e("button",{onClick:de,class:"btn btn-primary",disabled:g.value||!oe.value},[t[22]||(t[22]=e("i",{class:"fas fa-save"},null,-1)),f(" "+c(g.value?"جاري الحفظ...":"حفظ الخصم"),1)],8,Tt),e("button",{onClick:Z,class:"btn btn-secondary",disabled:g.value},t[23]||(t[23]=[e("i",{class:"fas fa-times"},null,-1),f(" إلغاء ")]),8,Dt)])])):v("",!0)])):v("",!0),n.selectedCustomer?(o(),u("div",At,[t[30]||(t[30]=e("h4",null,[e("i",{class:"fas fa-calculator"}),f(" الملخص المالي للعميل")],-1)),e("div",Pt,[e("div",Nt,[t[24]||(t[24]=e("span",{class:"label"},"إجمالي أسعار الأضاحي:",-1)),e("span",Mt,c(V(n.selectedCustomer.totalAmount)),1)]),B.value?(o(),u("div",Ft,[t[25]||(t[25]=e("span",{class:"label"},"خصم العميل:",-1)),e("span",Lt,"- "+c(V(n.selectedCustomer.discount)),1)])):v("",!0),B.value&&n.selectedCustomer.discountReason?(o(),u("div",Vt,[t[26]||(t[26]=e("span",{class:"label"},"سبب الخصم:",-1)),e("span",Bt,c(n.selectedCustomer.discountReason),1)])):v("",!0),e("div",Rt,[t[27]||(t[27]=e("span",{class:"label"},"إجمالي المدفوعات:",-1)),e("span",qt,c(V(n.selectedCustomer.totalPaidNIS)),1)]),t[29]||(t[29]=e("hr",{class:"summary-divider"},null,-1)),e("div",Kt,[t[28]||(t[28]=e("span",{class:"label"},"الرصيد المتبقي:",-1)),e("span",{class:I(["value",ie(n.selectedCustomer.balance)])},c(V(n.selectedCustomer.balance)),3)])])])):v("",!0),n.selectedCustomer?(o(),u("div",xt,[t[33]||(t[33]=e("h4",null,[e("i",{class:"fas fa-money-bill-wave"}),f(" مدفوعات العميل")],-1)),n.selectedCustomer.payments&&n.selectedCustomer.payments.length>0?(o(),u("div",Ot,[t[31]||(t[31]=e("p",null,[e("em",null,"(عرض قائمة المدفوعات هنا)")],-1)),e("ul",null,[(o(!0),u(J,null,X(n.selectedCustomer.payments,w=>(o(),u("li",{key:w.id}," تاريخ: "+c(new Date(w.paymentDate).toLocaleDateString())+" - الإجمالي: "+c(V(w.totalTransactionNIS)),1))),128))])])):(o(),u("div",zt,t[32]||(t[32]=[e("p",null,[e("i",{class:"fas fa-info-circle"}),f(" لا توجد مدفوعات مسجلة لهذا العميل.")],-1)])))])):v("",!0),U.value?(o(),u("div",Wt,[e("div",jt,[e("div",Ht,[e("h4",null,c(b.value.title),1)]),e("div",Gt,[e("p",null,c(b.value.message),1)]),e("div",{class:"dialog-footer"},[e("button",{onClick:se,class:"btn btn-secondary"}," إلغاء "),e("button",{onClick:be,class:"btn btn-danger"}," تأكيد ")])])])):v("",!0)]))}}),Xt=z(Jt,[["__scopeId","data-v-630d692a"]]),Yt={class:"customer-animal-relationship-page",dir:"rtl"},Zt={class:"main-content"},Qt={class:"customer-selection-section card-style"},ea={key:0,class:"customer-sacrifice-management"},sa={key:1,class:"empty-state card-style"},ta=O({__name:"CustomerAnimalRelationshipPage",setup(P){const _=h(null),r=Ee(),k=G(),i=h(null),d=m=>{_.value=m},y=()=>{_.value=null,i.value=null},p=async(m=!1)=>{const b=r.query.customerId;if(i.value=r.query.highlightAnimalId||null,b){if(m){const $=k.getCustomerById(b);$?(_.value={...$},console.log(`Selected customer ${b} data refreshed from store after update.`)):(console.error(`CRITICAL: Customer ${b} not found in store after dataUpdated event. Clearing selection. This might indicate an issue with store reactivity or update logic.`),_.value=null,i.value=null);return}let S=k.getCustomerById(b);!S&&k.customers.length===0&&!k.loading&&(console.log(`Customer ${b} not in empty store, fetching all customers.`),await k.fetchCustomers(),S=k.getCustomerById(b)),S?_.value={...S}:(console.warn(`Customer ${b} not found (initial load/direct nav). Clearing selection.`),_.value=null,i.value=null)}else _.value=null,i.value=null},U=()=>{console.log("dataUpdated event received in CustomerAnimalRelationshipPage. Refreshing customer data..."),p(!0)};return x(()=>{p()}),K(()=>r.query,(m,b)=>{(m.customerId!==b.customerId||m.highlightAnimalId!==b.highlightAnimalId)&&p()},{deep:!0}),(m,b)=>(o(),u("div",Yt,[e("div",Zt,[e("div",Qt,[H(xe,{onCustomerSelected:d,onCustomerCleared:y,"selected-customer":_.value},null,8,["selected-customer"])]),_.value?(o(),u("div",ea,[H(Xt,{"selected-customer":_.value,onDataUpdated:U,"highlight-animal-id":i.value},null,8,["selected-customer","highlight-animal-id"])])):(o(),u("div",sa,b[0]||(b[0]=[e("div",{class:"empty-state-content"},[e("i",{class:"fas fa-user-plus fa-3x"}),e("h3",null,"اختر عميل لإدارة أضاحيه"),e("p",null,"استخدم القائمة أعلاه لاختيار عميل وإدارة أضاحيه")],-1)])))])]))}}),na=z(ta,[["__scopeId","data-v-c95b1a66"]]);export{na as default};
