import{d as L,p as ne,r as E,q as S,s as se,o as oe,c as u,a,m as g,w as le,b as J,g as ue,y as h,L as re,e as B,E as ie,f as I,A,F as q,i as w,t as c,v as k,h as o,_ as T,H as de,I as ce}from"./index-D2cXNYYD.js";import{u as me}from"./payments-CZv0c8BV.js";let F=(N=21)=>crypto.getRandomValues(new Uint8Array(N)).reduce((f,i)=>(i&=63,i<36?f+=i.toString(36):i<62?f+=(i-26).toString(36).toUpperCase():i>62?f+="-":f+="_",f),"");const ve={class:"payment-form-container",dir:"rtl"},pe={class:"form-group"},fe=["disabled"],ye=["value"],be={key:0},_e={key:0,class:"customer-balance-info"},ge={key:0,class:"customer-discount-info"},he={class:"discount-summary"},Se={key:0,class:"discount-reason"},Ie={class:"financial-breakdown"},De={class:"breakdown-row"},Ee={class:"value"},Ne={class:"breakdown-row discount-row"},Pe={class:"value discount-amount"},qe={class:"breakdown-row total-row"},we={class:"value final-total"},ke={class:"balance-summary"},Ce={key:0},Ue={key:1},Ae={key:2},Fe={class:"form-row"},Ve={class:"form-group amount-group"},xe=["for"],Me=["id","onUpdate:modelValue"],Oe={class:"form-group currency-group"},$e=["for"],Be=["id","onUpdate:modelValue","onChange"],Le={key:0,class:"form-group nis-equivalent-group"},Je=["for"],Te=["id","onUpdate:modelValue"],Re={class:"form-group"},He=["for"],We=["id","onUpdate:modelValue"],Ye=["value"],je=["onClick"],ze={class:"form-group"},Ge={class:"form-group"},Ke={key:1,class:"payment-summary"},Qe={class:"total-nis-equivalent"},Xe={class:"form-actions"},Ze=["disabled"],et=L({__name:"PaymentForm",props:{customerIdProp:{type:String,default:null}},emits:["payment-saved"],setup(N,{emit:f}){const i=N,y=me(),r=ne(),V=f,P=E(!1),d=E(null),v=E(""),R=["cash","bank_transfer","card","online","cheque","other"],C=()=>({id:F(),amount:null,currency:"NIS",nisEquivalent:void 0,method:"cash"}),l=E([C()]),b=E({paymentDate:Date.now(),notes:""}),x=S({get:()=>{const t=new Date(b.value.paymentDate),e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),D=String(t.getDate()).padStart(2,"0");return`${e}-${n}-${D}`},set:t=>{t?b.value.paymentDate=new Date(t).getTime():b.value.paymentDate=Date.now()}}),H=S(()=>l.value.reduce((t,e)=>t+(e.amount||0),0)),W=S(()=>l.value.reduce((t,e)=>{const n=e.currency==="NIS"?e.amount||0:e.nisEquivalent||0;return t+n},0)),Y=S(()=>{const t={NIS:0,JOD:0,USD:0};return l.value.forEach(e=>{e.amount&&e.currency&&(t[e.currency]+=e.amount)}),Object.entries(t).filter(([,e])=>e>0).map(([e,n])=>({currency:e,total:n}))}),s=S(()=>r.customers.find(t=>t.id===v.value)),j=S(()=>s.value&&s.value.discount&&s.value.discount>0);se(()=>i.customerIdProp,t=>{t&&(v.value=t,r.customers.find(e=>e.id===t)||r.fetchCustomerById(t))},{immediate:!0});const z=()=>{d.value=null,y.clearError(),v.value&&!r.customers.find(t=>t.id===v.value)&&r.fetchCustomerById(v.value)},G=()=>{if(s.value&&s.value.balance!==void 0&&s.value.balance>0&&l.value.length>0){const t=l.value[0];t.amount=s.value.balance,t.currency="NIS",t.nisEquivalent=void 0,d.value=null,y.clearError()}else s.value&&s.value.balance!==void 0&&s.value.balance<=0?d.value="الرصيد الحالي للعميل هو صفر أو مدين.":s.value||(d.value="يرجى اختيار عميل أولاً.")},K=t=>{t.currency,t.nisEquivalent=void 0,d.value=null,y.clearError()},M=()=>{l.value.push(C())},Q=t=>{l.value=l.value.filter(e=>e.id!==t),l.value.length===0&&M()},X=S(()=>r.loading||!v.value||l.value.length===0||l.value.every(t=>!t.amount||t.amount<=0)||l.value.some(t=>(t.currency==="JOD"||t.currency==="USD")&&(!t.nisEquivalent||t.nisEquivalent<=0))),Z=async()=>{if(d.value=null,y.clearError(),!v.value){d.value="يرجى اختيار عميل.";return}if(l.value.length===0||l.value.every(t=>!(t.amount&&t.amount>0))){d.value="يرجى إدخال مبلغ صحيح واحد على الأقل (أكبر من صفر).";return}for(const t of l.value){if(!t.amount||t.amount<=0){d.value=`بند الدفعة بمبلغ ${t.amount||"فارغ"} غير صالح. يجب أن يكون المبلغ أكبر من صفر.`;return}if((t.currency==="JOD"||t.currency==="USD")&&(!t.nisEquivalent||t.nisEquivalent<=0)){d.value=`يرجى إدخال قيمة المقابل بالشيكل لبند العملة ${t.currency} (يجب أن تكون أكبر من صفر).`;return}}try{await r.fetchCustomers();const t=r.getCustomerById(v.value);if(!t){d.value="لم يتم العثور على العميل.";return}await ee(t),V("payment-saved"),te()}catch(t){console.error("Failed to save payment:",t),d.value=t.message||"حدث خطأ أثناء حفظ الدفعة."}},ee=async t=>{var O,$;const e=l.value.map(p=>({id:F(),amount:p.amount,currency:p.currency,nisEquivalent:p.currency==="NIS"?p.amount:p.nisEquivalent||0,method:p.method})),n=e.reduce((p,U)=>p+(U.nisEquivalent||0),0),D={id:F(),parts:e,totalTransactionNIS:n,paymentDate:b.value.paymentDate,notes:((O=b.value.notes)==null?void 0:O.trim())||"-"},ae=[...Array.isArray(t.payments)?t.payments:[],D];await r.updateCustomer({id:t.id,payments:ae});for(const p of e){const U={customerId:v.value,amount:p.amount,currency:p.currency,nisEquivalent:p.nisEquivalent,paymentDate:b.value.paymentDate,method:p.method,notes:(($=b.value.notes)==null?void 0:$.trim())||"-",originalPaymentDetailId:D.id};await y.addPayment(U)}},te=()=>{l.value=[C()],b.value={paymentDate:Date.now(),notes:""},d.value=null,y.clearError(),i.customerIdProp||(v.value="")},_=(t,e="NIS")=>{if(typeof t!="number")return"N/A";const n=e==="NIS"?"he-IL":e==="JOD"?"ar-JO":"en-US";return new Intl.NumberFormat(n,{style:"currency",currency:e,minimumFractionDigits:2,maximumFractionDigits:2}).format(t)};return oe(async()=>{var t;(!r.customers.length||r.lastFetchTimestamp===0)&&await r.fetchCustomers(),i.customerIdProp&&(v.value=i.customerIdProp,(!r.customers.find(e=>e.id===i.customerIdProp)||((t=r.customers.find(e=>e.id===i.customerIdProp))==null?void 0:t.balance)===void 0)&&await r.fetchCustomerById(i.customerIdProp)),b.value.paymentDate=Date.now()}),(t,e)=>(o(),u("div",ve,[e[21]||(e[21]=a("h3",null,[a("i",{class:"fas fa-plus-circle"}),g(" إضافة دفعة جديدة ")],-1)),a("form",{onSubmit:le(Z,["prevent"])},[J(re,{loading:B(r).loading||P.value},null,8,["loading"]),d.value?(o(),ue(ie,{key:0,message:d.value},null,8,["message"])):h("",!0),a("div",pe,[e[9]||(e[9]=a("label",{for:"customer"},"العميل",-1)),I(a("select",{id:"customer","onUpdate:modelValue":e[0]||(e[0]=n=>v.value=n),required:"",onChange:z,disabled:!!N.customerIdProp},[e[3]||(e[3]=a("option",{value:"",disabled:""},"اختر العميل...",-1)),(o(!0),u(q,null,w(B(r).customers,n=>(o(),u("option",{key:n.id,value:n.id},[g(c(n.name)+" ",1),n.balance!==void 0?(o(),u("span",be,"(الرصيد: "+c(_(n.balance,"NIS"))+")",1)):h("",!0)],8,ye))),128))],40,fe),[[A,v.value]]),s.value&&s.value.balance!==void 0?(o(),u("div",_e,[j.value?(o(),u("div",ge,[a("div",he,[e[5]||(e[5]=a("i",{class:"fas fa-percent"},null,-1)),a("strong",null,"خصم العميل: "+c(_(s.value.discount||0,"NIS")),1),s.value.discountReason?(o(),u("div",Se,[a("small",null,[e[4]||(e[4]=a("i",{class:"fas fa-info-circle"},null,-1)),g(" السبب: "+c(s.value.discountReason),1)])])):h("",!0)]),a("div",Ie,[a("div",De,[e[6]||(e[6]=a("span",{class:"label"},"المجموع الأصلي:",-1)),a("span",Ee,c(_(s.value.totalAmountBeforeDiscount||s.value.totalAmount||0,"NIS")),1)]),a("div",Ne,[e[7]||(e[7]=a("span",{class:"label"},"الخصم:",-1)),a("span",Pe,"- "+c(_(s.value.discount||0,"NIS")),1)]),a("div",qe,[e[8]||(e[8]=a("span",{class:"label"},"المجموع النهائي:",-1)),a("span",we,c(_(s.value.finalTotalAmount||s.value.totalAmount||0,"NIS")),1)])])])):h("",!0),a("div",ke,[s.value.balance>0?(o(),u("span",Ce," الدين الحالي على العميل: "+c(_(s.value.balance,"NIS"))+" (دين على العميل) ",1)):s.value.balance<0?(o(),u("span",Ue," الرصيد الزائد للعميل: "+c(_(Math.abs(s.value.balance),"NIS"))+" (رصيد زائد للعميل) ",1)):(o(),u("span",Ae," الرصيد: "+c(_(0,"NIS"))+" (خالص) ",1)),s.value.balance>0&&l.value.length>0?(o(),u("button",{key:3,type:"button",onClick:G,class:"btn btn-link btn-sm",style:{"margin-right":"5px"}}," دفع كامل الدين (لأول بند) ")):h("",!0)])])):h("",!0)]),(o(!0),u(q,null,w(l.value,(n,D)=>(o(),u("div",{key:n.id,class:"payment-entry-row"},[a("h4",null,[e[10]||(e[10]=a("i",{class:"fas fa-money-bill-wave"},null,-1)),g(" بند الدفعة #"+c(D+1),1)]),a("div",Fe,[a("div",Ve,[a("label",{for:"paymentAmount-"+n.id},"المبلغ",8,xe),I(a("input",{type:"number",id:"paymentAmount-"+n.id,"onUpdate:modelValue":m=>n.amount=m,required:"",step:"any",placeholder:"0.00"},null,8,Me),[[k,n.amount,void 0,{number:!0}]])]),a("div",Oe,[a("label",{for:"paymentCurrency-"+n.id},"العملة",8,$e),I(a("select",{id:"paymentCurrency-"+n.id,"onUpdate:modelValue":m=>n.currency=m,onChange:m=>K(n)},e[11]||(e[11]=[a("option",{value:"NIS"},"شيكل (NIS)",-1),a("option",{value:"JOD"},"دينار أردني (JOD)",-1),a("option",{value:"USD"},"دولار أمريكي (USD)",-1)]),40,Be),[[A,n.currency]])])]),n.currency==="JOD"||n.currency==="USD"?(o(),u("div",Le,[a("label",{for:"paymentNisEquivalent-"+n.id},e[12]||(e[12]=[g("المقابل بالشيكل "),a("span",{class:"required-star"},"*",-1)]),8,Je),I(a("input",{type:"number",id:"paymentNisEquivalent-"+n.id,"onUpdate:modelValue":m=>n.nisEquivalent=m,required:"",step:"any",placeholder:"0.00"},null,8,Te),[[k,n.nisEquivalent,void 0,{number:!0}]])])):h("",!0),a("div",Re,[a("label",{for:"paymentMethod-"+n.id},"طريقة الدفع للبند",8,He),I(a("select",{id:"paymentMethod-"+n.id,"onUpdate:modelValue":m=>n.method=m},[(o(),u(q,null,w(R,m=>a("option",{key:m,value:m},c(m),9,Ye)),64))],8,We),[[A,n.method]])]),l.value.length>1?(o(),u("button",{key:1,type:"button",onClick:m=>Q(n.id),class:"btn btn-danger btn-sm remove-entry-btn"},e[13]||(e[13]=[a("i",{class:"fas fa-trash"},null,-1),g(" إزالة هذا البند ")]),8,je)):h("",!0)]))),128)),a("button",{type:"button",onClick:M,class:"btn btn-success btn-sm add-entry-btn"},e[14]||(e[14]=[a("i",{class:"fas fa-plus"},null,-1),g(" إضافة بند دفع آخر ")])),e[19]||(e[19]=a("hr",{class:"section-divider"},null,-1)),e[20]||(e[20]=a("h4",null,[a("i",{class:"fas fa-calendar-alt"}),g(" تفاصيل المعاملة العامة")],-1)),a("div",ze,[e[15]||(e[15]=a("label",{for:"paymentDate"},"تاريخ الدفعة",-1)),I(a("input",{type:"date",id:"paymentDate","onUpdate:modelValue":e[1]||(e[1]=n=>x.value=n),required:""},null,512),[[k,x.value]])]),a("div",Ge,[e[16]||(e[16]=a("label",{for:"notes"},"ملاحظات (اختياري للمعاملة)",-1)),I(a("textarea",{id:"notes","onUpdate:modelValue":e[2]||(e[2]=n=>b.value.notes=n),rows:"3",placeholder:"مثال: دفعة مقدمة، رقم الإيصال..."},null,512),[[k,b.value.notes]])]),H.value>0?(o(),u("div",Ke,[e[17]||(e[17]=a("h4",null,"ملخص الدفعة الإجمالي:",-1)),(o(!0),u(q,null,w(Y.value,n=>(o(),u("p",{key:n.currency}," إجمالي ("+c(n.currency)+"): "+c(_(n.total,n.currency)),1))),128)),a("p",Qe,[a("strong",null,"الإجمالي الكلي المدفوع (المقابل بالشيكل): "+c(_(W.value,"NIS")),1)])])):h("",!0),a("div",Xe,[a("button",{type:"submit",class:"btn btn-primary",disabled:X.value},e[18]||(e[18]=[a("i",{class:"fas fa-plus"},null,-1),g(" حفظ الدفعة ")]),8,Ze)])],32)]))}}),tt=T(et,[["__scopeId","data-v-809b5edd"]]),at={class:"payment-form-page",dir:"rtl"},nt={class:"container"},st={class:"card-style"},ot=L({__name:"PaymentFormPage",setup(N){const f=de(),i=ce(),y=E(null),r=()=>{alert("تم حفظ الدفعة بنجاح!"),y.value?i.push({name:"PaymentList",query:{customerId:y.value}}):i.push({name:"PaymentList"})};return f.query.customerId&&typeof f.query.customerId=="string"&&(y.value=f.query.customerId),(V,P)=>(o(),u("div",at,[P[0]||(P[0]=a("h2",null,[a("i",{class:"fas fa-plus-circle"}),g(" إضافة دفعة جديدة ")],-1)),a("div",nt,[a("div",st,[J(tt,{onPaymentSaved:r,"customer-id-prop":y.value},null,8,["customer-id-prop"])])])]))}}),rt=T(ot,[["__scopeId","data-v-cc1eb680"]]);export{rt as default};
