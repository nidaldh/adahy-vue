import{d as V,q as D,c as i,y as d,a as e,w as Q,m as p,n as F,t as a,h as o,_ as O,p as W,r as I,s as X,o as R,F as $,b as x,g as Z,f as P,A as T,i as L,e as C,B as tt,L as et,E as nt,J as st,C as H,j as ot,l as at,I as lt}from"./index-D2cXNYYD.js";import{u as z}from"./payments-CZv0c8BV.js";const it={class:"dialog-header"},rt={class:"dialog-body"},ut={class:"dialog-actions"},dt=["disabled"],ct=["disabled"],mt={key:0,class:"fas fa-spinner fa-spin"},ft=V({__name:"ConfirmDialog",props:{isVisible:{type:Boolean,default:!1},title:{type:String,default:"تأكيد العملية"},message:{type:String,required:!0},confirmText:{type:String,default:"تأكيد"},cancelText:{type:String,default:"إلغاء"},type:{type:String,default:"warning"},loading:{type:Boolean,default:!1},closeOnOverlayClick:{type:Boolean,default:!0}},emits:["confirm","cancel","close"],setup(r,{emit:_}){const f=r,b=_,u=D(()=>{switch(f.type){case"danger":return"fas fa-exclamation-triangle text-danger";case"warning":return"fas fa-exclamation-circle text-warning";case"info":default:return"fas fa-info-circle text-info"}}),c=D(()=>{const m="btn";switch(f.type){case"danger":return`${m} btn-danger`;case"warning":return`${m} btn-warning`;case"info":default:return`${m} btn-primary`}}),h=()=>{f.loading||b("confirm")},k=()=>{f.loading||b("cancel")},w=()=>{f.closeOnOverlayClick&&!f.loading&&b("close")};return(m,l)=>r.isVisible?(o(),i("div",{key:0,class:"confirm-dialog-overlay",onClick:w},[e("div",{class:"confirm-dialog",onClick:l[0]||(l[0]=Q(()=>{},["stop"]))},[e("div",it,[e("h3",null,[e("i",{class:F(u.value)},null,2),p(" "+a(r.title),1)])]),e("div",rt,[e("p",null,a(r.message),1)]),e("div",ut,[e("button",{onClick:k,class:"btn btn-secondary",disabled:r.loading},a(r.cancelText),9,dt),e("button",{onClick:h,class:F(c.value),disabled:r.loading},[r.loading?(o(),i("i",mt)):d("",!0),p(" "+a(r.confirmText),1)],10,ct)])])])):d("",!0)}}),vt=O(ft,[["__scopeId","data-v-4da8da58"]]),gt={class:"payment-history-container",dir:"rtl"},yt={class:"filters"},pt={key:0,class:"form-group filter-customer"},ht=["value"],Ct={key:0},bt={class:"form-group filter-currency"},St={class:"form-group filter-method"},Dt=["disabled"],kt={key:1,class:"empty-state"},wt={key:2,class:"table-responsive"},It={class:"payments-table"},_t={key:0},xt={key:0},Nt={key:0,class:"customer-discount-in-history"},$t={class:"notes-cell"},Pt={class:"actions-cell"},Tt=["onClick"],Ft={class:"totals-container"},Vt={key:0,class:"total-payments"},Ot={class:"total-section"},Bt={key:0,class:"total-row"},Ut={key:1,class:"total-row"},Jt={key:2,class:"total-row"},Mt={class:"total-row highlight"},Et={class:"transactions-count"},qt=V({__name:"PaymentHistory",props:{filterCustomerIdProp:{type:String,default:null},showCustomerFilter:{type:Boolean,default:!1}},emits:[],setup(r,{expose:_,emit:f}){const b=r,u=z(),c=W(),h=I(""),k=I(""),w=I(""),m=I(!1),l=I({isVisible:!1,title:"تأكيد حذف الدفعة",message:"",confirmText:"حذف",cancelText:"إلغاء",type:"danger",loading:!1,paymentToDelete:null}),S=async()=>{await u.fetchPayments()};X(()=>b.filterCustomerIdProp,n=>{h.value=n||""},{immediate:!0});const v=D(()=>{let n=u.payments;return h.value&&(n=n.filter(t=>t.customerId===h.value)),k.value&&(n=n.filter(t=>t.currency===k.value)),w.value&&(n=n.filter(t=>t.method===w.value)),n.sort((t,s)=>{const y=new Date(t.paymentDate).getTime();return new Date(s.paymentDate).getTime()-y})}),j=D(()=>v.value.reduce((n,t)=>{const s=t.currency==="NIS"?t.amount:t.nisEquivalent||0;return n+s},0)),B=D(()=>v.value.filter(n=>n.currency==="NIS").reduce((n,t)=>n+t.amount,0)),U=D(()=>v.value.filter(n=>n.currency==="JOD").reduce((n,t)=>n+t.amount,0)),J=D(()=>v.value.filter(n=>n.currency==="USD").reduce((n,t)=>n+t.amount,0)),M=n=>{const t=c.customers.find(s=>s.id===n);return t?t.name:"عميل غير معروف"},E=n=>{const t=c.customers.find(s=>s.id===n);return t&&H(t.discount)&&t.discount?`${g(t.discount.amount,"NIS")} ${t.discount.reason?"("+t.discount.reason+")":""}`.trim():null},g=(n,t="NIS")=>{if(typeof n!="number")return"N/A";const s=t==="NIS"?"he-IL":t==="JOD"?"ar-JO":"en-US";return new Intl.NumberFormat(s,{style:"currency",currency:t,minimumFractionDigits:2,maximumFractionDigits:2}).format(n)},q=n=>{if(!n)return"-";try{const t=new Date(n),s=t.getFullYear(),y=String(t.getMonth()+1).padStart(2,"0"),A=String(t.getDate()).padStart(2,"0");return`${s}-${y}-${A}`}catch(t){return console.error("Error formatting date:",n,t),"تاريخ غير صالح"}},Y=n=>({cash:"نقداً",bank_transfer:"تحويل بنكي",card:"بطاقة ائتمان/خصم",online:"دفع إلكتروني",cheque:"شيك",other:"أخرى"})[n]||n,G=n=>{const t=M(n.customerId);l.value={...l.value,isVisible:!0,message:`هل أنت متأكد من حذف هذه الدفعة؟

العميل: ${t}
المبلغ: ${g(n.amount,n.currency)}
التاريخ: ${q(n.paymentDate)}

سيتم حذف هذه الدفعة من سجل المدفوعات وإعادة حساب رصيد العميل.`,paymentToDelete:n,loading:!1}},K=async()=>{if(l.value.paymentToDelete){l.value.loading=!0;try{const n=l.value.paymentToDelete;await u.deletePayment(n.id);const t=c.customers.find(s=>s.id===n.customerId);if(t&&t.payments){const s=t.payments.filter(y=>y.id!==n.originalPaymentDetailId);await c.updateCustomer({id:t.id,payments:s})}await S(),N()}catch(n){console.error("Error deleting payment:",n),u.setError("فشل في حذف الدفعة: "+(n.message||"خطأ غير معروف"))}finally{l.value.loading=!1}}},N=()=>{l.value.isVisible=!1,l.value.paymentToDelete=null,l.value.loading=!1};return R(async()=>{(!c.customers.length||c.lastFetchTimestamp===0)&&await c.fetchCustomers(),h.value=b.filterCustomerIdProp||"",await S()}),_({fetchPayments:S}),(n,t)=>(o(),i($,null,[e("div",gt,[t[25]||(t[25]=e("h3",null,[e("i",{class:"fas fa-history"}),p(" سجل المدفوعات")],-1)),e("div",yt,[r.showCustomerFilter?(o(),i("div",pt,[t[5]||(t[5]=e("label",{for:"filterCustomer"},"فلترة حسب العميل:",-1)),P(e("select",{id:"filterCustomer","onUpdate:modelValue":t[0]||(t[0]=s=>h.value=s),onChange:S},[t[4]||(t[4]=e("option",{value:""},"جميع العملاء",-1)),(o(!0),i($,null,L(C(c).customers,s=>{var y;return o(),i("option",{key:s.id,value:s.id},[p(a(s.name)+" ",1),C(H)(s.discount)?(o(),i("span",Ct,"(خصم: "+a(g(((y=s.discount)==null?void 0:y.amount)||0,"NIS"))+")",1)):d("",!0)],8,ht)}),128))],544),[[T,h.value]])])):d("",!0),e("div",bt,[t[7]||(t[7]=e("label",{for:"filterCurrency"},"العملة:",-1)),P(e("select",{id:"filterCurrency","onUpdate:modelValue":t[1]||(t[1]=s=>k.value=s),onChange:S},t[6]||(t[6]=[e("option",{value:""},"جميع العملات",-1),e("option",{value:"NIS"},"شيكل (NIS)",-1),e("option",{value:"JOD"},"دينار أردني (JOD)",-1),e("option",{value:"USD"},"دولار أمريكي (USD)",-1)]),544),[[T,k.value]])]),e("div",St,[t[9]||(t[9]=e("label",{for:"filterMethod"},"طريقة الدفع:",-1)),P(e("select",{id:"filterMethod","onUpdate:modelValue":t[2]||(t[2]=s=>w.value=s),onChange:S},t[8]||(t[8]=[tt('<option value="" data-v-987505a4>جميع طرق الدفع</option><option value="cash" data-v-987505a4>نقداً</option><option value="bank_transfer" data-v-987505a4>تحويل بنكي</option><option value="card" data-v-987505a4>بطاقة ائتمان/خصم</option><option value="online" data-v-987505a4>دفع إلكتروني</option><option value="cheque" data-v-987505a4>شيك</option><option value="other" data-v-987505a4>أخرى</option>',7)]),544),[[T,w.value]])]),e("button",{onClick:S,class:"btn btn-secondary btn-sm filter-button",disabled:C(u).loading},t[10]||(t[10]=[e("i",{class:"fas fa-filter"},null,-1),p(" تطبيق الفلتر / تحديث ")]),8,Dt)]),x(et,{loading:C(u).loading},null,8,["loading"]),C(u).error?(o(),Z(nt,{key:0,message:C(u).error},null,8,["message"])):d("",!0),!C(u).loading&&!v.value.length&&!C(u).error?(o(),i("div",kt,t[11]||(t[11]=[e("p",null,"لا توجد مدفوعات لعرضها تطابق الفلترة الحالية.",-1)]))):d("",!0),v.value.length?(o(),i("div",wt,[e("table",It,[e("thead",null,[e("tr",null,[r.showCustomerFilter?(o(),i("th",_t,"العميل")):d("",!0),t[12]||(t[12]=e("th",null,"المبلغ الأصلي",-1)),t[13]||(t[13]=e("th",null,"العملة",-1)),t[14]||(t[14]=e("th",null,"المقابل بالشيكل (NIS)",-1)),t[15]||(t[15]=e("th",null,"تاريخ الدفع",-1)),t[16]||(t[16]=e("th",null,"طريقة الدفع",-1)),t[17]||(t[17]=e("th",null,"ملاحظات",-1)),t[18]||(t[18]=e("th",null,"إجراءات",-1))])]),e("tbody",null,[(o(!0),i($,null,L(v.value,s=>(o(),i("tr",{key:s.id},[r.showCustomerFilter?(o(),i("td",xt,[p(a(M(s.customerId))+" ",1),E(s.customerId)?(o(),i("div",Nt,[e("small",null,[t[19]||(t[19]=e("i",{class:"fas fa-tag"},null,-1)),p(" خصم العميل: "+a(E(s.customerId)),1)])])):d("",!0)])):d("",!0),e("td",null,a(g(s.amount,s.currency)),1),e("td",null,a(s.currency),1),e("td",null,a(g(s.nisEquivalent||s.amount,"NIS")),1),e("td",null,a(q(s.paymentDate)),1),e("td",null,a(Y(s.method||"cash")),1),e("td",$t,a(s.notes||"-"),1),e("td",Pt,[e("button",{onClick:y=>G(s),class:"btn btn-outline-danger btn-xs",title:"حذف الدفعة"},t[20]||(t[20]=[e("i",{class:"fas fa-trash"},null,-1)]),8,Tt)])]))),128))])])])):d("",!0),e("div",Ft,[e("button",{onClick:t[3]||(t[3]=s=>m.value=!m.value),class:"btn-toggle-totals"},[e("i",{class:F([m.value?"fas fa-chevron-up":"fas fa-chevron-down","toggle-icon"]),style:st({transform:m.value?"rotate(0)":"rotate(180deg)"})},null,6),p(" "+a(m.value?"إخفاء الإجماليات":"عرض الإجماليات"),1)]),m.value&&v.value.length?(o(),i("div",Vt,[e("div",Ot,[B.value>0?(o(),i("div",Bt,[t[21]||(t[21]=e("strong",null,"إجمالي المدفوعات (شيكل - NIS):",-1)),e("span",null,a(g(B.value,"NIS")),1)])):d("",!0),U.value>0?(o(),i("div",Ut,[t[22]||(t[22]=e("strong",null,"إجمالي المدفوعات (دينار - JOD):",-1)),e("span",null,a(g(U.value,"JOD")),1)])):d("",!0),J.value>0?(o(),i("div",Jt,[t[23]||(t[23]=e("strong",null,"إجمالي المدفوعات (دولار - USD):",-1)),e("span",null,a(g(J.value,"USD")),1)])):d("",!0),e("div",Mt,[t[24]||(t[24]=e("strong",null,"الإجمالي المكافئ بالشيكل:",-1)),e("span",null,a(g(j.value,"NIS")),1)])]),e("div",Et,[e("span",null,"عدد العمليات: "+a(v.value.length),1)])])):d("",!0)])]),x(vt,{"is-visible":l.value.isVisible,title:l.value.title,message:l.value.message,"confirm-text":l.value.confirmText,"cancel-text":l.value.cancelText,type:l.value.type,loading:l.value.loading,onConfirm:K,onCancel:N,onClose:N},null,8,["is-visible","title","message","confirm-text","cancel-text","type","loading"])],64))}}),At=O(qt,[["__scopeId","data-v-987505a4"]]),Lt={class:"payment-list-page",dir:"rtl"},Ht={class:"container"},Rt={class:"actions-bar"},zt={class:"card-style"},jt=V({__name:"PaymentListPage",setup(r){const _=I(null),f=z();return lt(),R(async()=>{f.payments.length||await f.fetchPayments()}),(b,u)=>{const c=at("router-link");return o(),i("div",Lt,[e("div",Ht,[e("div",Rt,[x(c,{to:{name:"PaymentForm"},class:"btn-add"},{default:ot(()=>u[0]||(u[0]=[e("i",{class:"fas fa-plus-circle"},null,-1),p(" إضافة دفعة جديدة ")])),_:1,__:[0]})]),e("div",zt,[x(At,{ref_key:"paymentHistoryRef",ref:_,showCustomerFilter:!0},null,512)])])])}}}),Kt=O(jt,[["__scopeId","data-v-99eb0a1b"]]);export{Kt as default};
